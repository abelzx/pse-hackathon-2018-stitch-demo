<!DOCTYPE html>
<html lang="en">

<head>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"  media="screen,projection"/>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="../css/main.css"></script>
  <script src="../node_modules/nexmo-stitch/dist/conversationClient.js"></script>
</head>

<body>

  <div align="center">
    <form id="login">
      <h1>You have requested to receive a call from support</h1>
      A support representative is standing by...
      <br>
      Please tell us your name:
      <input type="text" name="username" value="" style="max-width: 250px" autofocus>
      <br>
      <input type="submit" value="Enter" id="loginButton" />
      <br>
    </form>

    <div id="call-controls">
        You are in a call with Tony <button id="hang-up">Hang Up</button>
    </div>

    <section id="messages">
      <div>
        <audio id="audio">
          <source>
        </audio>
        <!--<button id="enable">Enable Audio</button>
        <button id="disable">Disable Audio</button>-->
      </div>
      <div>
        <button id="enable-video">Enable Video</button>
        <button id="enable-screenshare">Enable Screen Share</button>
        <button id="disable-video">Disable Video</button>
      </div>
      <div id="videos">
        <video id="self-video" autoplay muted></video>
        <video id="conversation-video" autoplay controls></video>
      </div>
      <h1>Messages</h1>

      <textarea id="messageTextarea"></textarea>
      <br>
      <button id="send">Send</button>
      
      <div id="messageFeed"></div>

    </section>

    <section id="conversations">
      <h1>Your support agent is Tony, you will receive a call on your computer very soon...</h1>
    </section>

    <br>
    <img src="../bkg.jpg" alt="Contact Support" style="max-width: 500px">
  </div>

  <script>
    const USER_JWT = ''
    const YOUR_EXTENSION_ID = ''
    const SECOND_USER_JWT = ''

    class ChatApp {
      constructor() {
        this.messageTextarea = document.getElementById('messageTextarea')
        this.messageFeed = document.getElementById('messageFeed')
        this.sendButton = document.getElementById('send')
        this.loginForm = document.getElementById('login')
        this.loginButton = document.getElementById('loginButton')
        this.conversationList = document.getElementById('conversations')
        this.leaveButton = document.getElementById('leave')
        this.audio = document.getElementById('audio')
        this.selfVideo = document.getElementById('self-video')
        this.conversationVideo = document.getElementById('conversation-video')
        //this.enableButton = document.getElementById('enable')
        //this.disableButton = document.getElementById('disable')
        this.enableVideoButton = document.getElementById('enable-video')
        this.enableScreenShareButton = document.getElementById('enable-screenshare')
        this.disableVideoButton = document.getElementById('disable-video')
        //this.callPhoneForm = document.getElementById('call-phone-form')
        this.callControls = document.getElementById('call-controls')
        this.hangUpButton = document.getElementById('hang-up')
        this.callMembers = document.getElementById('call-members')
        this.setupUserEvents()
      }

      errorLogger(error) {
        console.log(error)
      }

      eventLogger(event) {
        return () => {
          console.log("'%s' event was sent", event)
        }
      }

      memberEventHandler(type) {
        return (member, event) => {
          const date = new Date(Date.parse(event.timestamp))
          console.log(`*** ${member.user.name} ${type} the conversation`)
          const text = `${member.user.name} @ ${date}: <b>${type} the conversation</b><br>`
          this.messageFeed.innerHTML = text + this.messageFeed.innerHTML
        }
      }

      authenticate(username) {
        return username.toLowerCase() === "abel" ? USER_JWT : SECOND_USER_JWT
      }

      showConversationHistory(conversation) {
        conversation.getEvents().then((events) => {
          var eventsHistory = ""

          events.forEach((value, key) => {
            if (conversation.members[value.from]) {
              const date = new Date(Date.parse(value.timestamp))
              switch (value.type) {
                case 'text:seen':
                  break;
                case 'text:delivered':
                  break;
                case 'text':
                  eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>${value.body.text}</b><br>` + eventsHistory
                  break;

                case 'member:joined':
                  eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>joined the conversation</b><br>` + eventsHistory
                  break;
                case 'member:left':
                  eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>left the conversation</b><br>` + eventsHistory
                  break;
                case 'member:invited':
                  eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>invited to the conversation</b><br>` + eventsHistory
                  break;

                case 'member:media':
                  /*if (value.body.audio !== undefined) {
                    eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>${value.body.audio ? "enabled" : "disabled"} audio</b><br>` + eventsHistory
                  } else {
                    eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>${value.body.video ? "enabled" : "disabled"} video</b><br>` + eventsHistory
                  }*/
                  break;
                default:
                  eventsHistory = `${conversation.members[value.from].user.name} @ ${date}: <b>unknown event</b><br>` + eventsHistory
              }
            }
          })

          this.messageFeed.innerHTML = eventsHistory + this.messageFeed.innerHTML
        })
      }

      setupConversationEvents(conversation) {
        this.conversation = conversation
        this.conversationList.style.display = 'none'
        document.getElementById("messages").style.display = "block"
        console.log('*** Conversation Retrieved', conversation)
        console.log('*** Conversation Member', conversation.me)

        // Bind to events on the conversation
        conversation.on('text', (sender, message) => {
          console.log('*** Message received', sender, message)
          const date = new Date(Date.parse(message.timestamp))
          const text = `${sender.user.name} @ ${date}: <b>${message.body.text}</b><br>`
          this.messageFeed.innerHTML = text + this.messageFeed.innerHTML

          if (sender.user.name !== this.conversation.me.user.name) {
            message.seen().then(this.eventLogger('text:seen')).catch(this.errorLogger)
          }
        })

        conversation.on("member:joined", this.memberEventHandler('joined'))
        conversation.on("member:left", this.memberEventHandler('left'))
        conversation.on("member:media", (member, event) => {
          console.log(`*** Member changed media state`, member, event)
          var text
          if (event.body.audio !== undefined) {
            text = `${member.user.name} <b>${event.body.audio ? 'enabled' : 'disabled'} audio in the conversation</b><br>`
          } else {
            text = `${member.user.name} <b>${event.body.video ? 'enabled' : 'disabled'} video in the conversation</b><br>`
          }
          this.messageFeed.innerHTML = text + this.messageFeed.innerHTML
        })

        this.showConversationHistory(conversation)

        conversation.on("text:seen", (data, text) => console.log(`${data.user.name} saw text: ${text.body.text}`))
        conversation.on("text:typing:off", data => console.log(`${data.user.name} stopped typing...`))
        conversation.on("text:typing:on", data => console.log(`${data.user.name} started typing...`))

        conversation.me.on("media:stream:on", (stream) => {
          if ("srcObject" in this.selfVideo) {
            this.selfVideo.srcObject = stream.localStream;
          } else {
            // Avoid using this in new browsers, as it is going away.
            this.selfVideo.src = window.URL.createObjectURL(stream.localStream);
          }
        })

        for (var i = Object.keys(conversation.members).length; i > 0; i--) {
          conversation.members[Object.keys(conversation.members)[i - 1]].on("media:stream:on", (stream) => {
            if ("srcObject" in this.conversationVideo) {
              this.conversationVideo.srcObject = stream.stream;
            } else {
              // Avoid using this in new browsers, as it is going away.
              this.conversationVideo.src = window.URL.createObjectURL(stream.stream);
            }
          })
        }
      }

      updateConversationsList(conversations) {
        let conversationsElement = document.createElement("ul")
        for (let id in conversations) {
          let conversationElement = document.createElement("li")
          conversationElement.textContent = conversations[id].display_name
          conversationElement.addEventListener("click", () => this.setupConversationEvents(conversations[id]))
          conversationsElement.appendChild(conversationElement)
        }

        if (!conversationsElement.childNodes.length) {
          conversationsElement.textContent = "You are not a member of any conversations"
        }

        this.conversationList.appendChild(conversationsElement)
        this.conversationList.style.display = 'block'
        this.loginForm.style.display = 'none'
      }

      setupAudioStream(stream) {
        // Older browsers may not have srcObject
        if ("srcObject" in this.audio) {
          this.audio.srcObject = stream;
        } else {
          // Avoid using this in new browsers, as it is going away.
          this.audio.src = window.URL.createObjectURL(stream);
        }
        this.audio.onloadedmetadata = () => {
          this.audio.play();
        }
      }

      showCallControls(member) {
        console.log(member)
        this.callControls.style.display = "block"
        this.callMembers.textContent = this.callMembers.textContent + " " + member.invited_by || member.user.name
      }

      handleCall(call) {
        this.setupAudioStream(call.application.activeStream.stream)
        this.call = call
        call.on("call:member:state", (from, state, event) => {
          if (state = "ANSWERED") {
            this.showCallControls(from)
          }
          console.log("member: " + from.user.name + " has " + state);
        });
      }

      listConversations(userToken) {

        new ConversationClient({
            debug: false,
            screenshareExtensionId: YOUR_EXTENSION_ID
          })
          .login(userToken)
          .then(app => {
            console.log('*** Logged into app', app)
            this.app = app

            app.on("member:call", (member, call) => {
              if (window.confirm(`Incoming call from Tony. Do you want to answer?`)) {
                this.call = call
                call.answer().then((stream) => {
                  this.setupAudioStream(stream)
                  this.showCallControls(member)
                })
              } else {
                call.hangUp()
              }
            })

            app.on("member:invited", (member, event) => {
              //identify the sender.
              console.log("*** Invitation received:", event);

              //accept an invitation.
              app.getConversation(event.cid || event.body.cname)
                .then((conversation) => {
                  this.conversation = conversation
                  conversation.join().then(() => {
                    var conversationDictionary = {}
                    conversationDictionary[this.conversation.id] = this.conversation
                    this.updateConversationsList(conversationDictionary)
                  }).catch(this.errorLogger)

                })
                .catch(this.errorLogger)
            })
            return app.getConversations()
          })
          .then((conversations) => {
            console.log('*** Retrieved conversations', conversations)

            this.updateConversationsList(conversations)

          })
          .catch(this.errorLogger)
      }

      setupUserEvents() {
        this.sendButton.addEventListener('click', () => {
          this.conversation.sendText(this.messageTextarea.value).then(() => {
            this.eventLogger('text')()
            this.messageTextarea.value = ''
          }).catch(this.errorLogger)

        })

        /*this.callPhoneForm.addEventListener('submit', (event) => {
          event.preventDefault()
          this.app.callPhone(this.callPhoneForm.children.phonenumber.value)
            .then(() => this.handleCall)
        })*/

        this.hangUpButton.addEventListener('click', () => {
          this.call.hangUp()
          this.callControls.style.display = "none"
        })

        this.loginForm.addEventListener('submit', (event) => {
          event.preventDefault()
          loginButton.disabled = true
          loginButton.value = 'Finding you an agent...'
          const userToken = this.authenticate(this.loginForm.children.username.value)
          if (userToken) {
            this.listConversations(userToken)
          }
        })

        this.messageTextarea.addEventListener('focus', () => {
          this.conversation.startTyping().then(this.eventLogger('text:typing:on')).catch(this.errorLogger)
        });
        this.messageTextarea.addEventListener('blur', () => {
          this.conversation.stopTyping().then(this.eventLogger('text:typing:off')).catch(this.errorLogger)
        })

        /*this.enableButton.addEventListener('click', () => {

          this.conversation.media.enable().then(stream => {
            // Older browsers may not have srcObject
            if ("srcObject" in this.audio) {
              this.audio.srcObject = stream;
            } else {
              // Avoid using this in new browsers, as it is going away.
              this.audio.src = window.URL.createObjectURL(stream);
            }

            this.audio.onloadedmetadata = () => {
              this.audio.play();
            }

            this.eventLogger('member:media')()
          }).catch(this.errorLogger)
        })

        this.disableButton.addEventListener('click', () => {
          this.conversation.media.disable().then(this.eventLogger('member:media')).catch(this.errorLogger)
        })*/

        this.enableVideoButton.addEventListener('click', () => {
          document.getElementById("videos").style.display = "block"
          document.getElementById("conversation-video").style.display = "block"
          this.conversation.media.enable({
            video: "both"
          }).then(this.eventLogger('member:media')).catch(this.errorLogger)
        })

        this.enableScreenShareButton.addEventListener('click', () => {
          document.getElementById("videos").style.display = "block"
          document.getElementById("conversation-video").style.display = "none"
          this.conversation.media.enable({
            screenshare: true
          }).then(this.eventLogger('member:media')).catch(this.errorLogger)
        })

        this.disableVideoButton.addEventListener('click', () => {
          document.getElementById("videos").style.display = "none"
          this.conversation.media.disable().then(this.eventLogger('member:media')).catch(this.errorLogger)
        })
      }
    }

    new ChatApp()
  </script>

</body>

</html>
